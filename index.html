<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>PNG Auto Crop</title>
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Pretendard', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #f6f5f9, #ffffff);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      color: #3a2f4d;
      max-width: 720px;
      margin: auto;
    }
    h1 { font-size: 28px; font-weight: 700; color: #4a3f63; margin-bottom: 8px; text-align: center; }
    p.subtitle { color: #555; margin-bottom: 28px; font-size: 15px; text-align: center; line-height: 1.6; }

    .upload-box {
      width: 100%; padding: 20px; border: 2px dashed #c2bfd0; border-radius: 12px;
      background: #fff; cursor: pointer; font-size: 14px; color: #3a2f4d; text-align: center;
      transition: all 0.2s ease;
    }
    .upload-box:hover { background: #faf9fc; border-color: #a084ca; }
    input[type=file] { display: none; }

    .btn {
      padding: 12px 30px; margin-top: 18px; background: #a084ca; color: #fff;
      border: none; border-radius: 25px; cursor: pointer; font-size: 15px; font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn:hover { background: #8c6fc7; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

    #preview {
      margin-top: 32px; width: 100%; text-align: center; border: 1px solid #e2e2e2;
      padding: 18px; background: #fff; border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    #thumbs {
      display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; width: 100%;
    }
    #thumbs div { position: relative; display: inline-block; text-align: center; }
    #thumbs img {
      width: 120px; height: 120px; object-fit: contain;
      border: 1px solid #ccc; border-radius: 8px; background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08); cursor: pointer;
    }
    #thumbs button {
      position: absolute; top: 6px; right: 6px; background: none; border: none;
      color: #333; font-size: 20px; font-weight: 300;
      cursor: pointer; line-height: 1; padding: 0;
    }
    #thumbs button:hover { color: #000; }

    #loading { margin-top: 20px; font-size: 15px; color: #6c5b7b; display: none; font-weight: 600; }
    #loading .scissors { display: inline-block; animation: cut 1s infinite; }
    @keyframes cut {
      0% { transform: rotate(0deg); } 25% { transform: rotate(-20deg); }
      50% { transform: rotate(0deg); } 75% { transform: rotate(20deg); }
      100% { transform: rotate(0deg); }
    }

    .ads { margin: 20px 0; width: 100%; text-align: center; display: none; }
  </style>
</head>
<body>
  <h1>PNG Auto Crop</h1>
  <p class="subtitle">
    One-click PNG cropping. Say goodbye to empty transparent space.<br>
    클릭 한 번으로 PNG 여백 제거
  </p>

  <!-- 업로드 -->
  <label for="file" class="upload-box">
    PNG 파일을 선택하거나 드래그하세요<br>
    <span style="font-size:13px; color:#888;">Select or Drag & Drop PNG (Up to 3)</span>
  </label>
  <input type="file" id="file" accept="image/png" multiple>

  <!-- 썸네일 -->
  <div id="thumbs"></div>

  <!-- 크롭 버튼 -->
  <button class="btn" onclick="upload()"> 크롭 | Crop</button>

  <!-- 로딩 -->
  <div id="loading"><span class="scissors">✂️</span> 작업 중... / Processing...</div>

  <!-- 결과 -->
  <div id="preview"></div>

  <script>
    const API_BASE = "https://loopyti-loopyti-crop-tool.hf.space/crop";
    let selectedFiles = [];

    // 파일 업로드
    document.getElementById("file").addEventListener("change", (e) => {
      const newFiles = Array.from(e.target.files);

      for (const f of newFiles) {
        if (f.type !== "image/png") {
          alert("⚠️ PNG 파일만 업로드할 수 있습니다.");
          e.target.value = "";
          return;
        }
      }

      selectedFiles = [...selectedFiles, ...newFiles];
      if (selectedFiles.length > 3) {
        alert("⚠️ 최대 3개의 PNG만 업로드할 수 있습니다.");
        selectedFiles = selectedFiles.slice(0, 3);
      }

      renderThumbnails();
      e.target.value = "";
    });

    // 썸네일 렌더링
    function renderThumbnails() {
      const thumbs = document.getElementById("thumbs");
      thumbs.innerHTML = "";
      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const wrapper = document.createElement("div");

          const img = document.createElement("img");
          img.src = ev.target.result;
          img.onclick = () => window.open(img.src, "_blank");

          const delBtn = document.createElement("button");
          delBtn.textContent = "✖";
          delBtn.onclick = () => { selectedFiles.splice(index, 1); renderThumbnails(); };

          const resultDiv = document.createElement("div");
          resultDiv.id = "result_" + index;
          resultDiv.style.marginTop = "6px";

          wrapper.appendChild(img);
          wrapper.appendChild(delBtn);
          wrapper.appendChild(resultDiv);
          thumbs.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
      });
    }

    // 업로드 & 크롭
    async function upload() {
      if (!selectedFiles.length) {
        alert("⚠️ PNG 파일을 선택해주세요.");
        return;
      }
      const loading = document.getElementById("loading");
      const preview = document.getElementById("preview");
      loading.style.display = "block";
      preview.innerHTML = "";

      // ZIP 요청
      const formDataZip = new FormData();
      selectedFiles.forEach(f => formDataZip.append("files", f));
      try {
        const resZip = await fetch(API_BASE + "/zip", { method:"POST", body:formDataZip });
        if (!resZip.ok) throw new Error(await resZip.text());
        const blobZip = await resZip.blob();
        const urlZip = URL.createObjectURL(blobZip);

        preview.innerHTML = `
          <div style="margin-bottom:20px; text-align:center;">
            <h3 style="color:#6c5b7b; font-weight:600;">전체 ZIP 다운로드</h3>
            <a href="${urlZip}" download="cropped_images.zip">
              <button class="btn" style="margin-top:10px;">⬇️ ZIP 다운로드</button>
            </a>
          </div>
        `;
      } catch(err) {
        preview.innerHTML = `<p style="color:red;">ZIP 오류: ${err.message}</p>`;
      }

      // 개별 PNG 요청
      selectedFiles.forEach(async (file, index) => {
        const fd = new FormData();
        fd.append("file", file);
        try {
          const res = await fetch(API_BASE + "/png", { method:"POST", body:fd });
          if (!res.ok) throw new Error(await res.text());
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          const target = document.getElementById("result_" + index);
          target.innerHTML = "";

          const croppedImg = document.createElement("img");
          croppedImg.src = url;
          croppedImg.style.width = "120px";
          croppedImg.style.cursor = "pointer";
          croppedImg.style.border = "1px solid #ccc";
          croppedImg.style.borderRadius = "6px";
          croppedImg.onclick = () => {
            const modal = document.createElement("div");
            modal.style.position = "fixed";
            modal.style.top = "0"; modal.style.left = "0";
            modal.style.width = "100%"; modal.style.height = "100%";
            modal.style.background = "rgba(0,0,0,0.7)";
            modal.style.display = "flex";
            modal.style.alignItems = "center";
            modal.style.justifyContent = "center";
            modal.onclick = () => modal.remove();

            const bigImg = document.createElement("img");
            bigImg.src = url;
            bigImg.style.maxWidth = "90%";
            bigImg.style.maxHeight = "90%";
            bigImg.style.border = "4px solid white";
            bigImg.style.borderRadius = "10px";

            modal.appendChild(bigImg);
            document.body.appendChild(modal);
          };

          const link = document.createElement("a");
          link.href = url;
          link.download = "cropped_" + file.name;

          const dlBtn = document.createElement("button");
          dlBtn.textContent = "⬇️ 개별 PNG 다운로드";
          dlBtn.className = "btn";
          dlBtn.style.marginTop = "6px";

          link.appendChild(dlBtn);

          target.appendChild(croppedImg);
          target.appendChild(link);
        } catch(err) {
          document.getElementById("result_" + index).innerHTML =
            `<p style="color:red;">PNG 오류: ${err.message}</p>`;
        }
      });

      loading.style.display = "none";
    }
  </script>
</body>
</html>
